<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vi Khu·∫©n Phi√™u L∆∞u - T·ª± So·∫°n</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <!-- KaTeX CSS for LaTeX formulas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8b5wDZjI7GMQN0LfdssjSSrDu724LRIk",
            authDomain: "giaoviencongnghe-3c2a9.firebaseapp.com",
            projectId: "giaoviencongnghe-3c2a9",
            storageBucket: "giaoviencongnghe-3c2a9.firebasestorage.app",
            messagingSenderId: "1098765432100",
            appId: "1:1098765432100:web:abcdef123456",
            databaseURL: "https://giaoviencongnghe-3c2a9-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const firebaseDb = firebase.database();

        // Firebase Helper Functions
        async function saveQuizToFirebase(questions) {
            try {
                const quizData = {
                    questions: questions,
                    createdAt: Date.now()
                };
                const newRef = await firebaseDb.ref('bacteria_game_quizzes').push(quizData);
                return newRef.key;
            } catch (error) {
                console.error('Error saving quiz to Firebase:', error);
                throw error;
            }
        }

        async function getQuizFromFirebase(quizId) {
            try {
                const snapshot = await firebaseDb.ref(`bacteria_game_quizzes/${quizId}`).once('value');
                const data = snapshot.val();
                return data ? data.questions : null;
            } catch (error) {
                console.error('Error fetching quiz from Firebase:', error);
                return null;
            }
        }
    </script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes wing-flap {
            0% {
                transform: scaleY(1);
            }

            50% {
                transform: scaleY(0.6);
            }

            100% {
                transform: scaleY(1);
            }
        }

        .animate-wings {
            transform-origin: center;
            animation: wing-flap 0.1s linear infinite;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .shake {
            animation: shake 0.3s ease-in-out 2;
        }

        @keyframes bounce-slow {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .animate-bounce-slow {
            animation: bounce-slow 2s infinite;
        }

        @keyframes loadingBar {
            0% {
                width: 5%;
            }

            50% {
                width: 95%;
            }

            100% {
                width: 5%;
            }
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // =========================================================
        // CONSTANTS
        // =========================================================
        const GameStage = {
            SETUP: 'SETUP',
            INTRO: 'INTRO',
            INTRO_VIDEO: 'INTRO_VIDEO',
            PLAYING: 'PLAYING',
            VICTORY_PENDING: 'VICTORY_PENDING',
            OUTRO_VIDEO: 'OUTRO_VIDEO',
            VICTORY: 'VICTORY',
        };

        const INTRO_VIDEO_URL = "/video-vi-khuan-dau.mp4";
        const OUTRO_VIDEO_URL = "/video-vi-khuan-ket.mp4";

        // L·∫•y storage key theo user email (ph√¢n bi·ªát c√¢u h·ªèi theo t·ª´ng user)
        const getStorageKey = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const userEmail = urlParams.get('user');
            if (userEmail) {
                return `bacteria_game_editable_questions_${userEmail}`;
            }
            return 'bacteria_game_editable_questions_guest';
        };

        // =========================================================
        // UTILITY FUNCTIONS
        // =========================================================
        const encodeQuestions = (questions) => {
            try {
                const json = JSON.stringify(questions);
                return btoa(unescape(encodeURIComponent(json)));
            } catch (e) {
                return '';
            }
        };

        const decodeQuestions = (encoded) => {
            try {
                const json = decodeURIComponent(escape(atob(encoded)));
                return JSON.parse(json);
            } catch (e) {
                return null;
            }
        };

        const getPathPoints = (totalStages) => {
            const points = [{ x: 10, y: 20 }]; // Start
            for (let i = 1; i <= totalStages; i++) {
                const x = 10 + (80 / (totalStages + 1)) * i;
                const y = i % 2 === 1 ? 35 : 15;
                points.push({ x, y });
            }
            points.push({ x: 90, y: 20 }); // Hive
            return points;
        };

        // =========================================================
        // SVG COMPONENTS
        // =========================================================
        const BacteriaSVG = ({ className }) => (
            <svg viewBox="0 0 100 100" className={className} xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="2" />
                        <feOffset dx="1" dy="2" result="offsetblur" />
                        <feComponentTransfer><feFuncA type="linear" slope="0.3" /></feComponentTransfer>
                        <feMerge><feMergeNode in="offsetblur" /><feMergeNode in="SourceGraphic" /></feMerge>
                    </filter>
                    <linearGradient id="bacteriaGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stopColor="#81C784" />
                        <stop offset="100%" stopColor="#4CAF50" />
                    </linearGradient>
                </defs>
                <g className="animate-float" filter="url(#shadow)">
                    {/* Flagella (l√¥ng roi) */}
                    <path d="M 20 50 Q 5 40 0 55 Q -5 70 10 65" stroke="#66BB6A" strokeWidth="3" fill="none" className="animate-wings" style={{ transformOrigin: "20px 50px" }} />
                    <path d="M 20 55 Q 0 60 -5 45 Q -8 30 8 40" stroke="#66BB6A" strokeWidth="2.5" fill="none" className="animate-wings" style={{ transformOrigin: "20px 55px", animationDelay: '0.05s' }} />
                    <path d="M 20 45 Q 5 35 2 50" stroke="#66BB6A" strokeWidth="2" fill="none" className="animate-wings" style={{ transformOrigin: "20px 45px", animationDelay: '0.1s' }} />

                    {/* Body - h√¨nh b·∫ßu d·ª•c xanh l√° */}
                    <ellipse cx="55" cy="50" rx="35" ry="28" fill="url(#bacteriaGrad)" stroke="#388E3C" strokeWidth="2" />

                    {/* Highlight */}
                    <ellipse cx="45" cy="40" rx="15" ry="10" fill="white" opacity="0.3" />

                    {/* M·∫Øt to tr√≤n */}
                    <circle cx="45" cy="48" r="8" fill="white" />
                    <circle cx="65" cy="48" r="8" fill="white" />
                    <circle cx="46" cy="49" r="5" fill="#3E2723" />
                    <circle cx="66" cy="49" r="5" fill="#3E2723" />
                    <circle cx="47" cy="47" r="2" fill="white" />
                    <circle cx="67" cy="47" r="2" fill="white" />

                    {/* M√° h·ªìng */}
                    <circle cx="35" cy="55" r="5" fill="#FF8A80" opacity="0.6" />
                    <circle cx="75" cy="55" r="5" fill="#FF8A80" opacity="0.6" />

                    {/* Mi·ªáng c∆∞·ªùi */}
                    <path d="M 50 60 Q 55 68 60 60" stroke="#2E7D32" strokeWidth="3" fill="none" strokeLinecap="round" />
                </g>
            </svg>
        );

        const YogurtJarSVG = ({ className }) => (
            <svg viewBox="0 0 100 100" className={className} xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="jarGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stopColor="#FFFFFF" />
                        <stop offset="100%" stopColor="#E8F5E9" />
                    </linearGradient>
                    <linearGradient id="yogurtGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stopColor="#FFF9C4" />
                        <stop offset="100%" stopColor="#FFECB3" />
                    </linearGradient>
                </defs>
                <g transform="translate(10, 5)">
                    {/* N·∫Øp h≈© */}
                    <rect x="25" y="5" width="50" height="12" rx="3" fill="#E91E63" stroke="#C2185B" strokeWidth="2" />
                    <rect x="30" y="8" width="40" height="3" fill="#F48FB1" opacity="0.5" />

                    {/* Th√¢n h≈© */}
                    <path d="M 20 17 L 20 75 Q 20 90 50 90 Q 80 90 80 75 L 80 17 Z" fill="url(#jarGrad)" stroke="#81C784" strokeWidth="2" />

                    {/* S·ªØa chua b√™n trong */}
                    <path d="M 25 30 L 25 70 Q 25 82 50 82 Q 75 82 75 70 L 75 30 Q 60 35 50 30 Q 40 25 25 30" fill="url(#yogurtGrad)" />

                    {/* Highlight */}
                    <path d="M 28 35 L 28 55" stroke="white" strokeWidth="4" opacity="0.4" strokeLinecap="round" />

                    {/* Nh√£n */}
                    <rect x="30" y="45" width="40" height="25" rx="3" fill="#4CAF50" />
                    <text x="50" y="62" textAnchor="middle" fill="white" fontSize="10" fontWeight="bold">YOGURT</text>

                    {/* Trang tr√≠ tr√°i c√¢y */}
                    <circle cx="38" cy="53" r="4" fill="#FF5722" />
                    <circle cx="62" cy="53" r="4" fill="#FF9800" />
                </g>
            </svg>
        );

        const WarningSVG = ({ className }) => (
            <svg viewBox="0 0 100 100" className={className} xmlns="http://www.w3.org/2000/svg">
                <g transform="translate(50, 50)">
                    <path d="M 0 -35 L 40 35 L -40 35 Z" fill="#FFEB3B" stroke="#F57F17" strokeWidth="4" strokeLinejoin="round" />
                    <path d="M 0 -25 L 30 28 L -30 28 Z" fill="none" stroke="#FFF" strokeWidth="2" opacity="0.5" />
                    <path d="M 0 -12 L 0 12" stroke="#E65100" strokeWidth="6" strokeLinecap="round" />
                    <circle cx="0" cy="22" r="4" fill="#E65100" />
                </g>
            </svg>
        );

        const SoundOnSVG = ({ className }) => (
            <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
            </svg>
        );

        const SoundOffSVG = ({ className }) => (
            <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="1" y1="1" x2="23" y2="23" />
                <path d="M9 9v6a23 23 0 0 1-2 2H3V7h4" />
                <path d="M11 5v6" />
                <path d="M16 9l5 5" /><path d="M21 9l-5 5" />
            </svg>
        );

        const MaximizeSVG = ({ className }) => (
            <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="15 3 21 3 21 9" />
                <polyline points="9 21 3 21 3 15" />
                <line x1="21" y1="3" x2="14" y2="10" />
                <line x1="3" y1="21" x2="10" y2="14" />
            </svg>
        );

        const MinimizeSVG = ({ className }) => (
            <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="4 14 10 14 10 20" />
                <polyline points="20 10 14 10 14 4" />
                <line x1="14" y1="10" x2="21" y2="3" />
                <line x1="10" y1="14" x2="3" y2="21" />
            </svg>
        );

        // =========================================================
        // FORMULA TOOLBAR - C√¥ng c·ª• ch√®n c√¥ng th·ª©c
        // =========================================================
        const FORMULA_CATEGORIES = [
            {
                name: 'üìê To√°n c∆° b·∫£n',
                formulas: [
                    { label: 'x¬≤', code: '$x^2$', desc: 'L≈©y th·ª´a b·∫≠c 2' },
                    { label: 'x‚Åø', code: '$x^n$', desc: 'L≈©y th·ª´a b·∫≠c n' },
                    { label: '‚àöx', code: '$\\sqrt{x}$', desc: 'CƒÉn b·∫≠c 2' },
                    { label: '‚àõx', code: '$\\sqrt[3]{x}$', desc: 'CƒÉn b·∫≠c 3' },
                    { label: '¬Ω', code: '$\\frac{1}{2}$', desc: 'Ph√¢n s·ªë' },
                    { label: 'a/b', code: '$\\frac{a}{b}$', desc: 'Ph√¢n s·ªë a/b' },
                ]
            },
            {
                name: 'üî¢ S·ªë h·ªçc',
                formulas: [
                    { label: '¬±', code: '$\\pm$', desc: 'C·ªông tr·ª´' },
                    { label: '√ó', code: '$\\times$', desc: 'Nh√¢n' },
                    { label: '√∑', code: '$\\div$', desc: 'Chia' },
                    { label: '‚â†', code: '$\\neq$', desc: 'Kh√°c' },
                    { label: '‚â§', code: '$\\leq$', desc: 'Nh·ªè h∆°n ho·∫∑c b·∫±ng' },
                    { label: '‚â•', code: '$\\geq$', desc: 'L·ªõn h∆°n ho·∫∑c b·∫±ng' },
                ]
            },
            {
                name: 'üìä H√¨nh h·ªçc',
                formulas: [
                    { label: 'œÄ', code: '$\\pi$', desc: 'Pi' },
                    { label: '‚àû', code: '$\\infty$', desc: 'V√¥ c·ª±c' },
                    { label: '‚à†', code: '$\\angle$', desc: 'G√≥c' },
                    { label: '‚ñ≥', code: '$\\triangle$', desc: 'Tam gi√°c' },
                    { label: '‚ä•', code: '$\\perp$', desc: 'Vu√¥ng g√≥c' },
                    { label: '‚à•', code: '$\\parallel$', desc: 'Song song' },
                ]
            },
            {
                name: '‚öóÔ∏è H√≥a h·ªçc',
                formulas: [
                    { label: 'H‚ÇÇO', code: '$H_2O$', desc: 'N∆∞·ªõc' },
                    { label: 'CO‚ÇÇ', code: '$CO_2$', desc: 'Carbon dioxide' },
                    { label: 'O‚ÇÇ', code: '$O_2$', desc: 'Oxy' },
                    { label: 'N‚ÇÇ', code: '$N_2$', desc: 'Nit∆°' },
                    { label: 'H‚ÇÇSO‚ÇÑ', code: '$H_2SO_4$', desc: 'Axit sunfuric' },
                    { label: 'NaOH', code: '$NaOH$', desc: 'Natri hidroxit' },
                    { label: '‚Üí', code: '$\\rightarrow$', desc: 'Ph·∫£n ·ª©ng' },
                    { label: '‚áå', code: '$\\rightleftharpoons$', desc: 'C√¢n b·∫±ng' },
                ]
            },
            {
                name: 'üßÆ N√¢ng cao',
                formulas: [
                    { label: 'Œ£', code: '$\\sum_{i=1}^{n}$', desc: 'T·ªïng' },
                    { label: '‚à´', code: '$\\int_{a}^{b}$', desc: 'T√≠ch ph√¢n' },
                    { label: 'log', code: '$\\log_{a}{x}$', desc: 'Logarit' },
                    { label: 'lim', code: '$\\lim_{x \\to \\infty}$', desc: 'Gi·ªõi h·∫°n' },
                    { label: 'sin', code: '$\\sin{x}$', desc: 'Sin' },
                    { label: 'cos', code: '$\\cos{x}$', desc: 'Cos' },
                ]
            }
        ];

        const FormulaToolbar = ({ onInsert, targetId }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [activeCategory, setActiveCategory] = useState(0);

            const handleInsert = (code) => {
                onInsert(code);
                setIsOpen(false);
            };

            // Render preview c·ªßa c√¥ng th·ª©c
            const renderPreview = (code) => {
                try {
                    const formula = code.replace(/\$/g, '');
                    const html = katex.renderToString(formula, { throwOnError: false });
                    return React.createElement('span', { dangerouslySetInnerHTML: { __html: html } });
                } catch (e) {
                    return code;
                }
            };

            return (
                <div className="relative inline-block">
                    <button
                        type="button"
                        onClick={() => setIsOpen(!isOpen)}
                        className="px-3 py-1.5 bg-gradient-to-r from-purple-500 to-indigo-500 text-white text-sm font-bold rounded-lg hover:opacity-90 transition-all flex items-center gap-1 shadow-md"
                        title="Ch√®n c√¥ng th·ª©c to√°n h·ªçc/h√≥a h·ªçc"
                    >
                        <span>‚àë</span> C√¥ng th·ª©c
                    </button>

                    {isOpen && (
                        <div className="absolute left-0 top-full mt-2 w-80 bg-white rounded-xl shadow-2xl border-2 border-purple-200 z-50 overflow-hidden">
                            {/* Header */}
                            <div className="bg-gradient-to-r from-purple-500 to-indigo-500 text-white p-3 font-bold flex items-center justify-between">
                                <span>üìù Ch·ªçn c√¥ng th·ª©c</span>
                                <button onClick={() => setIsOpen(false)} className="hover:bg-white/20 rounded p-1">‚úï</button>
                            </div>

                            {/* Category tabs */}
                            <div className="flex flex-wrap gap-1 p-2 bg-gray-50 border-b">
                                {FORMULA_CATEGORIES.map((cat, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => setActiveCategory(idx)}
                                        className={`px-2 py-1 text-xs font-bold rounded-lg transition-all ${activeCategory === idx ? 'bg-purple-500 text-white' : 'bg-white text-gray-600 hover:bg-purple-100'}`}
                                    >
                                        {cat.name}
                                    </button>
                                ))}
                            </div>

                            {/* Formula grid */}
                            <div className="p-3 max-h-48 overflow-y-auto">
                                <div className="grid grid-cols-3 gap-2">
                                    {FORMULA_CATEGORIES[activeCategory].formulas.map((f, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => handleInsert(f.code)}
                                            className="p-2 bg-gray-50 hover:bg-purple-100 rounded-lg border border-gray-200 hover:border-purple-400 transition-all flex flex-col items-center gap-1"
                                            title={f.desc}
                                        >
                                            <span className="text-lg font-bold text-purple-700">{renderPreview(f.code)}</span>
                                            <span className="text-[10px] text-gray-500 truncate w-full text-center">{f.desc}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Hint */}
                            <div className="p-2 bg-yellow-50 border-t text-xs text-yellow-800 text-center">
                                üí° Nh·∫•p ƒë·ªÉ ch√®n c√¥ng th·ª©c v√†o √¥ ƒëang ch·ªçn
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =========================================================
        // SETUP SCREEN - Gi√°o vi√™n so·∫°n c√¢u h·ªèi
        // =========================================================
        const SetupScreen = ({ onStartGame, initialQuestions }) => {
            const [questions, setQuestions] = useState(initialQuestions || []);
            const [editingIndex, setEditingIndex] = useState(null);
            const [copied, setCopied] = useState(false);

            // Form state
            const [questionText, setQuestionText] = useState('');
            const [optionCount, setOptionCount] = useState(3);
            const [options, setOptions] = useState(['', '', '', '']);
            const [correctAnswer, setCorrectAnswer] = useState('A');

            // Track which input is focused for formula insertion
            const [activeInputField, setActiveInputField] = useState('question');
            const questionInputRef = useRef(null);
            const optionInputRefs = useRef([null, null, null, null]);

            // Insert formula into the active input field
            const insertFormula = (code) => {
                if (activeInputField === 'question') {
                    const input = questionInputRef.current;
                    if (input) {
                        const start = input.selectionStart || questionText.length;
                        const end = input.selectionEnd || questionText.length;
                        const newText = questionText.slice(0, start) + code + questionText.slice(end);
                        setQuestionText(newText);
                        // Set cursor after inserted code
                        setTimeout(() => {
                            input.focus();
                            input.setSelectionRange(start + code.length, start + code.length);
                        }, 0);
                    }
                } else if (activeInputField.startsWith('option')) {
                    const optionIndex = parseInt(activeInputField.replace('option', ''));
                    const input = optionInputRefs.current[optionIndex];
                    const currentValue = options[optionIndex];
                    if (input) {
                        const start = input.selectionStart || currentValue.length;
                        const end = input.selectionEnd || currentValue.length;
                        const newValue = currentValue.slice(0, start) + code + currentValue.slice(end);
                        const newOptions = [...options];
                        newOptions[optionIndex] = newValue;
                        setOptions(newOptions);
                        setTimeout(() => {
                            input.focus();
                            input.setSelectionRange(start + code.length, start + code.length);
                        }, 0);
                    }
                }
            };

            // Load from localStorage
            useEffect(() => {
                if (!initialQuestions || initialQuestions.length === 0) {
                    const saved = localStorage.getItem(getStorageKey());
                    if (saved) {
                        try {
                            setQuestions(JSON.parse(saved));
                        } catch (e) { }
                    }
                }
            }, []);

            // Save to localStorage
            useEffect(() => {
                if (questions.length > 0) {
                    localStorage.setItem(getStorageKey(), JSON.stringify(questions));
                }
            }, [questions]);

            const resetForm = () => {
                setQuestionText('');
                setOptions(['', '', '', '']);
                setCorrectAnswer('A');
                setEditingIndex(null);
            };

            const handleAddQuestion = () => {
                if (!questionText.trim()) return;

                const filledOptions = options.slice(0, optionCount).filter(o => o.trim());
                if (filledOptions.length < optionCount) {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c ƒë√°p √°n!');
                    return;
                }

                const newQuestion = {
                    id: editingIndex !== null ? questions[editingIndex].id : Date.now(),
                    question: questionText.trim(),
                    options: options.slice(0, optionCount).map((text, i) => ({
                        id: String.fromCharCode(65 + i),
                        text: text.trim()
                    })),
                    correctAnswerId: correctAnswer
                };

                if (editingIndex !== null) {
                    const updated = [...questions];
                    updated[editingIndex] = newQuestion;
                    setQuestions(updated);
                } else {
                    setQuestions([...questions, newQuestion]);
                }
                resetForm();
            };

            const handleEditQuestion = (index) => {
                const q = questions[index];
                setQuestionText(q.question);
                setOptionCount(q.options.length);
                const opts = ['', '', '', ''];
                q.options.forEach((opt, i) => { opts[i] = opt.text; });
                setOptions(opts);
                setCorrectAnswer(q.correctAnswerId);
                setEditingIndex(index);
            };

            const handleDeleteQuestion = (index) => {
                // X√≥a tr·ª±c ti·∫øp kh√¥ng c·∫ßn confirm (confirm b·ªã block trong iframe)
                setQuestions(questions.filter((_, i) => i !== index));
                if (editingIndex === index) resetForm();
            };

            const handleDeleteAll = () => {
                if (questions.length === 0) return;
                // X√≥a tr·ª±c ti·∫øp kh√¥ng c·∫ßn confirm
                setQuestions([]);
                localStorage.removeItem(getStorageKey());
                resetForm();
            };

            const [isCreatingLink, setIsCreatingLink] = useState(false);

            const handleCreateShareLink = async () => {
                if (questions.length < 1) {
                    alert('C·∫ßn √≠t nh·∫•t 1 c√¢u h·ªèi!');
                    return;
                }

                setIsCreatingLink(true);

                try {
                    // L∆∞u c√¢u h·ªèi v√†o Firebase v√† l·∫•y ID
                    const quizId = await saveQuizToFirebase(questions);
                    const shareUrl = `${window.location.origin}/bacteria-game-editable.html?id=${quizId}`;

                    await navigator.clipboard.writeText(shareUrl);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 3000);
                } catch (e) {
                    console.error('L·ªói t·∫°o link:', e);
                    // Fallback: d√πng c√°ch m√£ h√≥a base64 c≈© n·∫øu Firebase l·ªói
                    try {
                        const encoded = encodeQuestions(questions);
                        const fallbackUrl = `${window.location.origin}/bacteria-game-editable.html?q=${encoded}`;
                        await navigator.clipboard.writeText(fallbackUrl);
                        setCopied(true);
                        setTimeout(() => setCopied(false), 3000);
                    } catch (clipErr) {
                        alert('Kh√¥ng th·ªÉ t·∫°o link. Vui l√≤ng th·ª≠ l·∫°i!');
                    }
                } finally {
                    setIsCreatingLink(false);
                }
            };

            const handleStartGame = () => {
                if (questions.length < 1) {
                    alert('C·∫ßn √≠t nh·∫•t 1 c√¢u h·ªèi!');
                    return;
                }
                onStartGame(questions);
            };

            const [saved, setSaved] = useState(false);
            const handleSave = () => {
                if (questions.length > 0) {
                    localStorage.setItem(getStorageKey(), JSON.stringify(questions));
                    setSaved(true);
                    setTimeout(() => setSaved(false), 2000);

                    // G·ª≠i message ƒë·∫øn parent ƒë·ªÉ tr·ª´ l∆∞·ª£t trial
                    if (window.parent !== window) {
                        window.parent.postMessage({ type: 'BACTERIA_GAME_SAVE', questionsCount: questions.length }, '*');
                    }
                } else {
                    alert('Ch∆∞a c√≥ c√¢u h·ªèi n√†o ƒë·ªÉ l∆∞u!');
                }
            };

            const optionLabels = ['A', 'B', 'C', 'D'];

            return (
                <div className="min-h-screen bg-gradient-to-b from-green-50 via-teal-50 to-cyan-50 p-4 md:p-8">
                    <div className="max-w-4xl mx-auto">
                        {/* Header */}
                        <div className="text-center mb-6">
                            <div className="flex justify-center mb-4">
                                <div className="w-24 h-24"><BacteriaSVG /></div>
                            </div>
                            <h1 className="text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-500 to-teal-500">
                                ü¶† Vi Khu·∫©n Phi√™u L∆∞u - T·ª± So·∫°n üìù
                            </h1>
                            <p className="text-green-700 mt-2">T·∫°o c√¢u h·ªèi c·ªßa ri√™ng b·∫°n v√† chia s·∫ª cho h·ªçc sinh</p>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                            {/* Form th√™m c√¢u h·ªèi */}
                            <div className="bg-white rounded-2xl p-6 shadow-xl border-4 border-green-400">
                                <h2 className="text-xl font-bold text-green-700 mb-4 flex items-center gap-2">
                                    {editingIndex !== null ? '‚úèÔ∏è S·ª≠a c√¢u h·ªèi' : '‚ûï Th√™m c√¢u h·ªèi'}
                                </h2>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">N·ªôi dung c√¢u h·ªèi</label>
                                        <textarea
                                            ref={questionInputRef}
                                            value={questionText}
                                            onChange={(e) => setQuestionText(e.target.value)}
                                            onFocus={() => setActiveInputField('question')}
                                            className="w-full px-4 py-3 border-2 border-yellow-300 rounded-xl focus:border-orange-400 focus:outline-none resize-none"
                                            rows={3}
                                            placeholder="Nh·∫≠p c√¢u h·ªèi... (D√πng $...$ ƒë·ªÉ vi·∫øt c√¥ng th·ª©c, VD: $x^2$)"
                                        />
                                        <div className="mt-2">
                                            <FormulaToolbar onInsert={insertFormula} />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">S·ªë ƒë√°p √°n</label>
                                        <select
                                            value={optionCount}
                                            onChange={(e) => {
                                                const count = parseInt(e.target.value);
                                                setOptionCount(count);
                                                if (correctAnswer.charCodeAt(0) - 65 >= count) {
                                                    setCorrectAnswer('A');
                                                }
                                            }}
                                            className="w-full px-4 py-3 border-2 border-yellow-300 rounded-xl focus:border-orange-400 focus:outline-none"
                                        >
                                            <option value={2}>2 ƒë√°p √°n (A/B)</option>
                                            <option value={3}>3 ƒë√°p √°n (A/B/C)</option>
                                            <option value={4}>4 ƒë√°p √°n (A/B/C/D)</option>
                                        </select>
                                    </div>

                                    {optionLabels.slice(0, optionCount).map((label, i) => (
                                        <div key={label} className="flex items-center gap-2">
                                            <input
                                                type="radio"
                                                name="correct"
                                                checked={correctAnswer === label}
                                                onChange={() => setCorrectAnswer(label)}
                                                className="w-5 h-5 accent-green-500"
                                            />
                                            <span className={`w-8 h-8 flex items-center justify-center rounded-full font-bold text-white ${correctAnswer === label ? 'bg-green-500' : 'bg-yellow-400'}`}>
                                                {label}
                                            </span>
                                            <input
                                                type="text"
                                                ref={(el) => optionInputRefs.current[i] = el}
                                                value={options[i]}
                                                onChange={(e) => {
                                                    const newOpts = [...options];
                                                    newOpts[i] = e.target.value;
                                                    setOptions(newOpts);
                                                }}
                                                onFocus={() => setActiveInputField(`option${i}`)}
                                                className="flex-1 px-4 py-2 border-2 border-yellow-300 rounded-xl focus:border-orange-400 focus:outline-none"
                                                placeholder={`ƒê√°p √°n ${label}... (VD: $x = 2$)`}
                                            />
                                        </div>
                                    ))}

                                    <div className="flex gap-2">
                                        <button
                                            onClick={handleAddQuestion}
                                            className="flex-1 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-xl hover:opacity-90 transition-all"
                                        >
                                            {editingIndex !== null ? 'üíæ L∆∞u' : '‚ûï Th√™m'}
                                        </button>
                                        {editingIndex !== null && (
                                            <button
                                                onClick={resetForm}
                                                className="px-4 py-3 bg-gray-400 text-white font-bold rounded-xl hover:opacity-90"
                                            >
                                                H·ªßy
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Danh s√°ch c√¢u h·ªèi */}
                            <div className="bg-white rounded-2xl p-6 shadow-xl border-4 border-orange-400">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-xl font-bold text-orange-700 flex items-center gap-2">
                                        üìã Danh s√°ch ({questions.length} c√¢u)
                                    </h2>
                                    {questions.length > 0 && (
                                        <button
                                            onClick={handleDeleteAll}
                                            className="px-3 py-1.5 bg-red-500 text-white text-sm font-bold rounded-lg hover:bg-red-600 transition-all flex items-center gap-1"
                                        >
                                            üóëÔ∏è X√≥a h·∫øt
                                        </button>
                                    )}
                                </div>

                                {questions.length === 0 ? (
                                    <div className="text-center py-8 text-gray-400">
                                        <p className="text-4xl mb-2">üìù</p>
                                        <p>Ch∆∞a c√≥ c√¢u h·ªèi n√†o</p>
                                        <p className="text-sm">Th√™m √≠t nh·∫•t 1 c√¢u ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3 max-h-[400px] overflow-y-auto">
                                        {questions.map((q, index) => (
                                            <div key={q.id} className="p-3 bg-yellow-50 rounded-xl border-2 border-yellow-200">
                                                <div className="flex items-start justify-between gap-2">
                                                    <div className="flex-1">
                                                        <p className="font-bold text-gray-800 text-sm">
                                                            <span className="text-orange-500">#{index + 1}</span> {q.question}
                                                        </p>
                                                        <div className="mt-1 flex flex-wrap gap-1">
                                                            {q.options.map(opt => (
                                                                <span
                                                                    key={opt.id}
                                                                    className={`text-xs px-2 py-0.5 rounded-full ${opt.id === q.correctAnswerId ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-600'}`}
                                                                >
                                                                    {opt.id}: {opt.text.length > 15 ? opt.text.substring(0, 15) + '...' : opt.text}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleEditQuestion(index)} className="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm font-bold">‚úèÔ∏è</button>
                                                        <button onClick={() => handleDeleteQuestion(index)} className="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-bold">üóëÔ∏è</button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Action buttons */}
                        <div className="mt-6 flex flex-col sm:flex-row gap-4 justify-center flex-wrap">
                            <button
                                onClick={handleSave}
                                disabled={questions.length < 1}
                                className={`px-8 py-4 font-bold rounded-2xl shadow-lg transition-all flex items-center justify-center gap-2 ${questions.length >= 1
                                    ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white hover:opacity-90'
                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                            >
                                {saved ? '‚úÖ ƒê√£ l∆∞u!' : 'üíæ L∆∞u'}
                            </button>

                            <button
                                onClick={handleCreateShareLink}
                                disabled={questions.length < 1 || isCreatingLink}
                                className={`px-8 py-4 font-bold rounded-2xl shadow-lg transition-all flex items-center justify-center gap-2 ${questions.length >= 1 && !isCreatingLink
                                    ? 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white hover:opacity-90'
                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                            >
                                {isCreatingLink ? '‚è≥ ƒêang t·∫°o...' : copied ? '‚úÖ ƒê√£ copy!' : 'üîó T·∫°o link ng·∫Øn'}
                            </button>

                            <button
                                onClick={handleStartGame}
                                disabled={questions.length < 1}
                                className={`px-8 py-4 font-bold rounded-2xl shadow-lg transition-all flex items-center justify-center gap-2 ${questions.length >= 1
                                    ? 'bg-gradient-to-r from-orange-500 to-yellow-500 text-white hover:opacity-90'
                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                            >
                                üéÆ Ch∆°i th·ª≠
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // =========================================================
        // START SCREEN
        // =========================================================
        const StartScreen = ({ onStart, questionCount }) => (
            <div className="relative min-h-screen flex flex-col items-center justify-center p-4 bg-yellow-50">
                <div className="absolute inset-0 pointer-events-none overflow-hidden">
                    <div className="absolute inset-0 bg-gradient-to-b from-yellow-50 via-yellow-100 to-orange-50"></div>
                    <div className="absolute top-10 right-20 w-32 h-32 bg-yellow-300 rounded-full blur-xl opacity-60 animate-pulse"></div>
                </div>

                <div className="relative z-10 w-full max-w-5xl bg-white/95 shadow-2xl rounded-[2.5rem] p-6 md:p-8 border-8 border-green-400 text-center animate-float flex flex-col items-center justify-center">
                    <div className="flex justify-center mb-4 relative">
                        <div className="w-32 h-32 bg-gradient-to-br from-green-200 to-teal-100 rounded-full flex items-center justify-center shadow-inner border-4 border-white">
                            <BacteriaSVG className="w-24 h-24" />
                        </div>
                    </div>

                    <h1 className="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-500 to-teal-500 mb-4 drop-shadow-sm">
                        Vi Khu·∫©n Phi√™u L∆∞u
                    </h1>

                    <div className="bg-green-50 p-4 rounded-2xl border-4 border-dashed border-green-200 mb-6 text-left relative w-full max-w-3xl mx-auto">
                        <h2 className="text-xl font-bold text-green-700 mb-3 flex items-center">
                            <span className="text-2xl mr-2">üìú</span> H∆∞·ªõng d·∫´n ch∆°i:
                        </h2>
                        <ul className="space-y-2 text-green-900 text-lg font-medium">
                            <li className="flex items-start">
                                <span className="flex-shrink-0 w-7 h-7 bg-green-500 text-white rounded-full flex items-center justify-center font-bold mr-3 mt-0.5 text-sm">1</span>
                                <span>Gi√∫p ch√∫ Vi Khu·∫©n v∆∞·ª£t qua <span className="font-bold text-red-500">c√°c c·ª≠a ·∫£i</span> ƒë·ªÉ v·ªÅ h≈© s·ªØa chua.</span>
                            </li>
                            <li className="flex items-start">
                                <span className="flex-shrink-0 w-7 h-7 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-3 mt-0.5 text-sm">2</span>
                                <span>M·ªói c·ª≠a ·∫£i l√† m·ªôt <span className="font-bold text-blue-600">c√¢u ƒë·ªë th√∫ v·ªã</span> m√† em c·∫ßn gi·∫£i ƒë√°p.</span>
                            </li>
                            <li className="flex items-start">
                                <span className="flex-shrink-0 w-7 h-7 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold mr-3 mt-0.5 text-sm">3</span>
                                <span>Tr·∫£ l·ªùi ƒë√∫ng ƒë·ªÉ ƒë∆∞a Vi Khu·∫©n v·ªÅ nh√† an to√†n nh√©!</span>
                            </li>
                        </ul>
                    </div>

                    <button
                        onClick={onStart}
                        className="group relative inline-flex items-center justify-center px-10 py-4 text-xl font-bold text-white transition-all duration-200 bg-gradient-to-b from-green-400 to-teal-500 rounded-full shadow-[0_8px_0_rgb(20,83,45)] hover:shadow-[0_4px_0_rgb(20,83,45)] hover:translate-y-1 active:shadow-none active:translate-y-2 focus:outline-none"
                    >
                        <span className="mr-3 drop-shadow-md">B·∫Øt ƒê·∫ßu Ngay</span>
                        <svg className="w-6 h-6 transition-transform group-hover:translate-x-2 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                        </svg>
                    </button>
                </div>
            </div>
        );

        // =========================================================
        // LATEX RENDERER - Render c√¥ng th·ª©c to√°n h·ªçc
        // =========================================================
        const LatexRenderer = ({ text }) => {
            const renderLatex = (input) => {
                const parts = [];
                const regex = /\$\$([\s\S]*?)\$\$|\$((?:[^$\\]|\\.)+?)\$/g;

                let lastIndex = 0;
                let match;
                let keyIndex = 0;

                while ((match = regex.exec(input)) !== null) {
                    if (match.index > lastIndex) {
                        parts.push(
                            React.createElement('span', { key: `text-${keyIndex++}` },
                                input.slice(lastIndex, match.index)
                            )
                        );
                    }

                    const isDisplay = match[1] !== undefined;
                    const formula = isDisplay ? match[1] : match[2];

                    try {
                        const html = katex.renderToString(formula.trim(), {
                            throwOnError: false,
                            displayMode: isDisplay,
                            trust: true,
                        });

                        parts.push(
                            React.createElement('span', {
                                key: `latex-${keyIndex++}`,
                                className: isDisplay ? 'block my-2 text-center' : 'inline',
                                dangerouslySetInnerHTML: { __html: html }
                            })
                        );
                    } catch (error) {
                        parts.push(
                            React.createElement('span', { key: `error-${keyIndex++}`, className: 'text-red-500' },
                                isDisplay ? `$$${formula}$$` : `$${formula}$`
                            )
                        );
                    }

                    lastIndex = regex.lastIndex;
                }

                if (lastIndex < input.length) {
                    parts.push(
                        React.createElement('span', { key: `text-${keyIndex++}` },
                            input.slice(lastIndex)
                        )
                    );
                }

                return parts.length > 0 ? parts : [React.createElement('span', { key: 'empty' }, input)];
            };

            return React.createElement('span', null, renderLatex(text));
        };

        // =========================================================
        // QUESTION MODAL
        // =========================================================
        const QuestionModal = ({ question, questionIndex, onAnswer, playCorrectSound, playWrongSound, onPauseMusic }) => {
            const [selectedOption, setSelectedOption] = useState(null);
            const [showFeedback, setShowFeedback] = useState(null);
            const [timer, setTimer] = useState(5);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const countdownAudioRef = useRef(null);

            useEffect(() => {
                let interval;
                if (isTimerRunning && timer > 0) {
                    interval = setInterval(() => {
                        setTimer(prev => prev - 1);
                    }, 1000);
                } else if (timer === 0 && isTimerRunning) {
                    setIsTimerRunning(false);
                }
                return () => clearInterval(interval);
            }, [isTimerRunning, timer]);

            const handleStartTimer = () => {
                onPauseMusic(); // Pause background music
                setIsTimerRunning(true);
                // Play countdown audio/video
                if (countdownAudioRef.current) {
                    countdownAudioRef.current.currentTime = 0;
                    countdownAudioRef.current.play().catch(() => { });
                } else {
                    const audio = new Audio('./sounds/video_dem_nguoc_5s-www_tiengdong_com.mp4');
                    audio.volume = 1.0;
                    countdownAudioRef.current = audio;
                    audio.play().catch(() => { });
                }
            };

            const handleOptionClick = (optionId) => {
                if (showFeedback === 'correct') return;
                setSelectedOption(optionId);

                if (optionId === question.correctAnswerId) {
                    setShowFeedback('correct');
                    playCorrectSound();
                    // Removed auto-advance logic
                } else {
                    setShowFeedback('incorrect');
                    playWrongSound();
                }
            };

            const tryAgain = () => {
                setShowFeedback(null);
                setSelectedOption(null);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center pb-4 md:pb-6 px-4 pointer-events-none">
                    <div className="relative w-full max-w-[630px] min-h-[35vh] bg-white rounded-[2rem] shadow-2xl overflow-visible border-[6px] border-white ring-4 ring-yellow-300 animate-float pointer-events-auto flex flex-col">
                        <div className="absolute -top-6 -left-6 text-5xl transform -rotate-12 drop-shadow-lg">üå∏</div>
                        <div className="absolute -bottom-6 -right-6 text-5xl transform rotate-12 drop-shadow-lg">üçÄ</div>

                        {/* Timer Button */}
                        <div className="absolute -top-14 left-1/2 -translate-x-1/2 z-50">
                            <button
                                onClick={handleStartTimer}
                                disabled={isTimerRunning || timer === 0}
                                className={`w-24 h-24 rounded-full border-4 border-white shadow-2xl flex flex-col items-center justify-center transition-all transform hover:scale-110 active:scale-95 ${isTimerRunning
                                    ? 'bg-red-500 text-white animate-pulse'
                                    : timer === 0
                                        ? 'bg-gray-400 text-gray-200'
                                        : 'bg-gradient-to-br from-blue-400 to-blue-600 text-white hover:from-blue-300 hover:to-blue-500'
                                    }`}
                            >
                                <span className="text-3xl">‚è±Ô∏è</span>
                                <span className="text-2xl font-black">{timer > 0 ? timer : 'üîî'}</span>
                            </button>
                        </div>

                        <div className="bg-gradient-to-r from-yellow-400 to-orange-400 p-4 text-center rounded-t-[1.5rem] border-b-4 border-yellow-200 flex-shrink-0 pt-10">
                            <h2 className="text-2xl font-extrabold text-white drop-shadow-md tracking-wide">
                                C√¢u h·ªèi s·ªë {questionIndex + 1}
                            </h2>
                        </div>

                        <div className="flex-1 p-6 py-4 md:py-6 bg-yellow-50/95 flex flex-col justify-center rounded-b-[1.5rem] relative">
                            <p className="text-xl md:text-2xl text-yellow-900 font-bold mb-4 leading-relaxed text-center">
                                <LatexRenderer text={question.question} />
                            </p>

                            <div className="space-y-3 relative">
                                {question.options.map((option) => {
                                    let buttonStyle = "border-2 border-yellow-200 bg-white hover:bg-yellow-100 hover:scale-[1.02] text-gray-700 shadow-sm";

                                    if (selectedOption === option.id) {
                                        if (showFeedback === 'correct') {
                                            buttonStyle = "bg-green-100 border-green-500 text-green-800 font-bold ring-4 ring-green-200 scale-[1.02]";
                                        } else if (showFeedback === 'incorrect') {
                                            buttonStyle = "bg-red-100 border-red-500 text-red-800 ring-4 ring-red-200";
                                        }
                                    }

                                    return (
                                        <button
                                            key={option.id}
                                            onClick={() => handleOptionClick(option.id)}
                                            className={`w-full p-3 md:p-4 text-left rounded-2xl transition-all duration-200 text-xl md:text-2xl group ${buttonStyle}`}
                                            disabled={showFeedback !== null}
                                        >
                                            <span className={`inline-block w-10 h-10 text-center leading-10 rounded-full mr-4 font-bold transition-colors text-xl ${selectedOption === option.id && showFeedback === 'correct' ? 'bg-green-500 text-white' :
                                                selectedOption === option.id && showFeedback === 'incorrect' ? 'bg-red-500 text-white' :
                                                    'bg-yellow-200 text-yellow-800 group-hover:bg-yellow-300'
                                                }`}>
                                                {option.id}
                                            </span>
                                            <LatexRenderer text={option.text} />
                                        </button>
                                    );
                                })}

                                {showFeedback === 'incorrect' && (
                                    <div className="absolute inset-0 z-10 flex flex-col items-center justify-center bg-white/95 backdrop-blur-sm rounded-2xl border-4 border-red-300 shadow-xl">
                                        <p className="text-red-600 font-bold text-2xl mb-4 text-center px-4">Ch∆∞a ƒë√∫ng r·ªìi em ∆°i! Th·ª≠ l·∫°i nh√©! ü§î</p>
                                        <button
                                            onClick={tryAgain}
                                            className="px-8 py-3 bg-red-500 text-white rounded-full font-bold text-xl hover:bg-red-600 transition-colors shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95"
                                        >
                                            Th·ª≠ l·∫°i
                                        </button>
                                    </div>
                                )}

                                {showFeedback === 'correct' && (
                                    <div className="absolute inset-0 z-10 flex flex-col items-center justify-center bg-white/95 backdrop-blur-sm rounded-2xl border-4 border-green-300">
                                        <p className="text-green-600 font-bold text-3xl animate-bounce mb-6 text-center px-4">üéâ Ch√≠nh x√°c! üéâ</p>
                                        <button
                                            onClick={() => onAnswer(true)}
                                            className="px-8 py-3 bg-green-500 text-white rounded-full font-bold text-2xl hover:bg-green-600 transition-colors shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 animate-pulse"
                                        >
                                            Ti·∫øp t·ª•c ‚ûî
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // =========================================================
        // VICTORY SCREEN
        // =========================================================
        const VictoryScreen = ({ onRestart, onBackToSetup, showButtons }) => (
            <div className="absolute inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full text-center border-4 border-green-400 relative overflow-hidden">
                    {showButtons && (
                        <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-20">
                            <div className="absolute top-10 left-10 w-4 h-4 bg-red-500 rounded-full animate-ping"></div>
                            <div className="absolute top-20 right-20 w-6 h-6 bg-blue-500 rounded-full animate-ping delay-100"></div>
                            <div className="absolute bottom-10 left-1/2 w-5 h-5 bg-green-500 rounded-full animate-ping delay-200"></div>
                        </div>
                    )}

                    <h2 className="text-4xl font-extrabold text-green-600 mb-4">Ch√∫c M·ª´ng!</h2>

                    {showButtons && (
                        <div className="flex justify-center items-center gap-4 mb-6">
                            <div className="w-24 h-24 transform translate-x-4"><BacteriaSVG /></div>
                            <div className="text-3xl animate-pulse">‚ù§Ô∏è</div>
                            <div className="w-24 h-24"><YogurtJarSVG /></div>
                        </div>
                    )}

                    <p className="text-xl text-gray-700 mb-8 leading-relaxed">
                        C√°c em ƒë√£ xu·∫•t s·∫Øc tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u h·ªèi v√† ƒë∆∞a ch√∫ Vi Khu·∫©n v·ªÅ h≈© s·ªØa chua an to√†n!
                        <br />
                        {showButtons && <span className="font-bold text-green-600 block mt-2 animate-bounce">C√°c em th·∫≠t gi·ªèi! üåü</span>}
                    </p>

                    {showButtons && (
                        <div className="flex flex-col sm:flex-row gap-3 justify-center">
                            <button
                                onClick={onBackToSetup}
                                className="inline-flex items-center justify-center px-6 py-3 text-lg font-bold text-gray-600 transition-all bg-gray-200 rounded-full hover:bg-gray-300 shadow-lg transform hover:scale-105"
                            >
                                ‚Üê V·ªÅ so·∫°n c√¢u h·ªèi
                            </button>
                            <button
                                onClick={onRestart}
                                className="inline-flex items-center justify-center px-8 py-3 text-lg font-bold text-white transition-all bg-green-500 rounded-full hover:bg-green-600 shadow-lg transform hover:scale-105"
                            >
                                üîÑ Ch∆°i L·∫°i
                            </button>
                        </div>
                    )}
                </div>
            </div>
        );

        // =========================================================
        // LOADING SCREEN
        // =========================================================
        const LoadingScreen = () => (
            <div className="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-green-50 overflow-hidden">
                <div className="absolute inset-0 bg-teal-100 opacity-50"></div>
                <div className="relative mb-10">
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 border-8 border-dashed border-green-200 rounded-full animate-[spin_10s_linear_infinite]"></div>
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-52 h-52 border-4 border-teal-300 rounded-full animate-[spin_8s_linear_infinite_reverse]"></div>
                    <div className="relative z-10 animate-bounce"><BacteriaSVG className="w-40 h-40 drop-shadow-xl" /></div>
                </div>
                <div className="relative z-10 flex flex-col items-center">
                    <h1 className="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-500 to-teal-500 tracking-[0.2em] mb-4 animate-pulse uppercase">
                        Loading...
                    </h1>
                    <div className="w-64 h-4 bg-white rounded-full border-2 border-green-200 p-1 shadow-inner relative overflow-hidden">
                        <div className="absolute top-0 bottom-0 left-0 bg-gradient-to-r from-green-400 to-teal-500 rounded-full animate-[loadingBar_2s_ease-in-out_infinite]" style={{ width: '50%' }}></div>
                    </div>
                </div>
            </div>
        );

        // =========================================================
        // BACKGROUND
        // =========================================================
        const YellowNatureBackground = () => (
            <div className="absolute inset-0 pointer-events-none overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-b from-green-50 via-teal-50 to-cyan-50"></div>
                <div className="absolute top-10 right-20 w-20 h-20 bg-green-300 rounded-full blur-xl opacity-60 animate-pulse"></div>
                <svg className="absolute bottom-0 left-0 w-full h-[50%] z-0" preserveAspectRatio="none" viewBox="0 0 1440 320">
                    <path fill="#D1FAE5" fillOpacity="1" d="M0,224L60,213.3C120,203,240,181,360,181.3C480,181,600,203,720,224C840,245,960,267,1080,261.3C1200,256,1320,224,1380,208L1440,192L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path>
                </svg>
                <svg className="absolute bottom-0 left-0 w-full h-[40%] z-0" preserveAspectRatio="none" viewBox="0 0 1440 320">
                    <path fill="#A7F3D0" fillOpacity="0.8" d="M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,213.3C672,192,768,128,864,128C960,128,1056,192,1152,208C1248,224,1344,192,1392,176L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
                </svg>
                <div className="absolute bottom-[10%] left-[10%] text-orange-300 text-4xl opacity-80 animate-bounce-slow">‚úø</div>
                <div className="absolute bottom-[8%] left-[45%] text-orange-400 text-5xl opacity-80 animate-bounce-slow" style={{ animationDelay: '0.5s' }}>‚úø</div>
                <div className="absolute bottom-[5%] right-[10%] text-orange-300 text-6xl opacity-80 animate-bounce-slow">‚úø</div>
                <div className="absolute top-[15%] left-[10%] text-white text-6xl opacity-60 animate-float">‚òÅ</div>
                <div className="absolute top-[10%] right-[20%] text-white text-8xl opacity-40 animate-float" style={{ animationDelay: '2s' }}>‚òÅ</div>
            </div>
        );

        // =========================================================
        // MAIN APP
        // =========================================================
        function App() {
            const [isLoading, setIsLoading] = useState(true);
            const [gameState, setGameState] = useState(GameStage.SETUP);
            const [questions, setQuestions] = useState([]);
            const [currentStationIndex, setCurrentStationIndex] = useState(0);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [beePosition, setBeePosition] = useState({ x: 10, y: 20 });
            const [isMusicMuted, setIsMusicMuted] = useState(false);
            const [pathPoints, setPathPoints] = useState([]);

            const audioRef = useRef(null);

            // Check URL for shared questions (Firebase ID or base64 encoded)
            useEffect(() => {
                const loadQuestions = async () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const quizId = urlParams.get('id');
                    const sharedData = urlParams.get('q');

                    // ∆Øu ti√™n ki·ªÉm tra Firebase ID tr∆∞·ªõc
                    if (quizId) {
                        const firebaseQuestions = await getQuizFromFirebase(quizId);
                        if (firebaseQuestions && firebaseQuestions.length >= 1) {
                            setQuestions(firebaseQuestions);
                            setPathPoints(getPathPoints(firebaseQuestions.length));
                            setGameState(GameStage.INTRO);
                            return;
                        }
                    }

                    // Fallback: ki·ªÉm tra d·ªØ li·ªáu m√£ h√≥a base64 (h·ªó tr·ª£ link c≈©)
                    if (sharedData) {
                        const decoded = decodeQuestions(sharedData);
                        if (decoded && decoded.length >= 1) {
                            setQuestions(decoded);
                            setPathPoints(getPathPoints(decoded.length));
                            setGameState(GameStage.INTRO);
                        }
                    }
                };

                loadQuestions();

                audioRef.current = new Audio('https://s2.file2s.com/nhacnengamechotreem.mp3');
                audioRef.current.loop = true;
                audioRef.current.volume = 0.35;

                setTimeout(() => setIsLoading(false), 2000);

                return () => {
                    if (audioRef.current) {
                        audioRef.current.pause();
                        audioRef.current = null;
                    }
                };
            }, []);

            const [volume, setVolume] = useState(0.35);
            const [showVolumeControl, setShowVolumeControl] = useState(false);
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [isTempPaused, setIsTempPaused] = useState(false); // New state for Timer pause

            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    setIsFullscreen(true);
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                        setIsFullscreen(false);
                    }
                }
            };

            // Audio control
            useEffect(() => {
                const playAudio = async () => {
                    if (audioRef.current) {
                        const isVideoPlaying = gameState === GameStage.INTRO_VIDEO || gameState === GameStage.OUTRO_VIDEO;
                        // Added !isTempPaused to condition
                        if (!isLoading && gameState !== GameStage.INTRO && gameState !== GameStage.SETUP && !isVideoPlaying && !isMusicMuted && !isTempPaused) {
                            try {
                                audioRef.current.volume = volume;
                                await audioRef.current.play();
                            } catch (e) { }
                        } else {
                            audioRef.current.pause();
                        }
                    }
                };
                playAudio();
            }, [gameState, isLoading, isMusicMuted, volume, isTempPaused]);

            // Update volume when slider changes
            useEffect(() => {
                if (audioRef.current) {
                    audioRef.current.volume = volume;
                }
            }, [volume]);

            const playCorrectSound = () => {
                const sfx = new Audio('https://s2.file2s.com/amthanhhieuung/dung-6.mp3');
                sfx.volume = 1.0;
                sfx.play().catch(() => { });
            };

            const playWrongSound = () => {
                const sfx = new Audio('https://s2.file2s.com/amthanhhieuung/sai-4.mp3');
                sfx.volume = 1.0;
                sfx.play().catch(() => { });
            };

            const handleStartFromSetup = (customQuestions) => {
                setQuestions(customQuestions);
                setPathPoints(getPathPoints(customQuestions.length));
                setGameState(GameStage.INTRO);
            };

            const handleStartGame = () => {
                setGameState(GameStage.INTRO_VIDEO);
            };

            const handleIntroVideoEnded = () => {
                setGameState(GameStage.PLAYING);
                setCurrentStationIndex(0);
                setBeePosition(pathPoints[0] || { x: 10, y: 20 });
                setTimeout(() => moveToStation(1), 600);
            };

            const handleOutroVideoEnded = () => {
                setGameState(GameStage.VICTORY);
            };

            const moveToStation = (index) => {
                if (pathPoints[index]) {
                    setBeePosition(pathPoints[index]);
                }
                setCurrentStationIndex(index);

                if (index > 0 && index <= questions.length) {
                    setTimeout(() => setIsModalOpen(true), 2000);
                } else if (index === questions.length + 1) {
                    setTimeout(() => {
                        setGameState(GameStage.VICTORY_PENDING);
                        setTimeout(() => setGameState(GameStage.OUTRO_VIDEO), 2500);
                    }, 2000);
                }
            };

            const handleAnswer = (isCorrect) => {
                if (isCorrect) {
                    setIsModalOpen(false);
                    setIsTempPaused(false); // Resume music
                    moveToStation(currentStationIndex + 1);
                }
            };

            const handleRestart = () => {
                setIsLoading(true);
                setIsTempPaused(false);
                setGameState(GameStage.INTRO);
                setCurrentStationIndex(0);
                setBeePosition(pathPoints[0] || { x: 10, y: 20 });
                setIsModalOpen(false);
                setTimeout(() => setIsLoading(false), 2000);
            };

            const handleBackToSetup = () => {
                setGameState(GameStage.SETUP);
                setIsTempPaused(false);
                setCurrentStationIndex(0);
                setIsModalOpen(false);
            };

            const toggleMusic = () => {
                if (isMusicMuted) {
                    setIsMusicMuted(false);
                    setVolume(0.35); // Restore default volume
                } else {
                    setIsMusicMuted(true);
                }
            };

            const toggleVolumeControl = () => setShowVolumeControl(!showVolumeControl);

            const renderVideoOverlay = (src, onEnded) => (
                <div className="fixed inset-0 z-[200] bg-black/80 flex items-center justify-center p-4">
                    <div className="relative w-[70%] max-w-5xl shadow-2xl rounded-xl overflow-hidden bg-black ring-4 ring-yellow-400">
                        <video src={src} autoPlay className="w-full h-auto aspect-video" onEnded={onEnded} controls={false} />
                        <button onClick={onEnded} className="absolute bottom-4 right-4 px-4 py-1.5 bg-white/20 hover:bg-white/40 text-white text-sm rounded-full backdrop-blur-md transition-colors">
                            B·ªè qua &gt;&gt;
                        </button>
                    </div>
                </div>
            );

            if (isLoading) return <LoadingScreen />;
            if (gameState === GameStage.SETUP) return <SetupScreen onStartGame={handleStartFromSetup} initialQuestions={questions} />;

            const showStartScreen = gameState === GameStage.INTRO || gameState === GameStage.INTRO_VIDEO;

            return (
                <div className="relative w-full h-screen overflow-hidden font-sans select-none bg-yellow-50">
                    {showStartScreen ? (
                        <StartScreen onStart={handleStartGame} questionCount={questions.length} />
                    ) : (
                        <React.Fragment>
                            <YellowNatureBackground />
                            <div className="relative z-10 w-full h-full flex flex-col">
                                {/* Header */}
                                <div className="absolute top-0 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none mt-2 w-full flex justify-center">
                                    <div className="bg-gradient-to-r from-green-400 via-teal-500 to-green-400 px-8 py-2 rounded-b-3xl shadow-[0_4px_0_rgb(20,83,45)] border-2 border-t-0 border-white/50 animate-float">
                                        <h1 className="text-xl md:text-2xl font-black text-white uppercase tracking-wider drop-shadow-md flex items-center gap-2">
                                            <span>ü¶†</span> Vi Khu·∫©n Phi√™u L∆∞u <span>ü•õ</span>
                                        </h1>
                                    </div>
                                </div>

                                {/* Controls */}
                                <div className="absolute top-16 left-4 right-4 flex justify-between items-center z-[100] pointer-events-none">
                                    <div className="bg-white/90 backdrop-blur-md px-6 py-2 rounded-full shadow-lg border-4 border-green-400 flex items-center gap-3 pointer-events-auto">
                                        <span className="text-2xl">üß©</span>
                                        <div>
                                            <p className="text-[10px] text-green-800 font-bold uppercase tracking-wider">C·ª≠a ·∫£i</p>
                                            <p className="text-lg font-extrabold text-green-600 leading-none">
                                                {Math.min(currentStationIndex, questions.length)} / {questions.length}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 pointer-events-auto relative">
                                        <button onClick={toggleFullscreen} className="w-12 h-12 bg-white/95 backdrop-blur-md rounded-full shadow-xl border-[3px] border-cyan-400 text-cyan-600 flex items-center justify-center transition-all hover:scale-110" title={isFullscreen ? "Thu nh·ªè" : "To√†n m√†n h√¨nh"}>
                                            {isFullscreen ? <MinimizeSVG className="w-6 h-6" /> : <MaximizeSVG className="w-6 h-6" />}
                                        </button>
                                        <button onClick={handleBackToSetup} className="w-12 h-12 bg-white/95 backdrop-blur-md rounded-full shadow-xl border-[3px] border-gray-400 flex items-center justify-center transition-all hover:scale-110" title="Quay l·∫°i">
                                            ‚Üê
                                        </button>

                                        <div className="relative">
                                            <button
                                                onClick={toggleVolumeControl}
                                                className={`w-12 h-12 bg-white/95 backdrop-blur-md rounded-full shadow-xl border-[3px] flex items-center justify-center transition-all hover:scale-110 ${isMusicMuted ? 'border-gray-400 text-gray-500' : 'border-teal-400 text-teal-600'}`}
                                                title="√Çm l∆∞·ª£ng"
                                            >
                                                {isMusicMuted || volume === 0 ? <SoundOffSVG className="w-6 h-6" /> : <SoundOnSVG className="w-6 h-6" />}
                                            </button>

                                            {showVolumeControl && (
                                                <div className="absolute top-14 right-0 w-12 h-32 bg-white/95 backdrop-blur-md rounded-full shadow-xl border-[3px] border-teal-400 flex flex-col items-center justify-center py-2 z-50 animate-slide-in">
                                                    <input
                                                        type="range"
                                                        min="0"
                                                        max="1"
                                                        step="0.01"
                                                        value={isMusicMuted ? 0 : volume}
                                                        onChange={(e) => {
                                                            const val = parseFloat(e.target.value);
                                                            setVolume(val);
                                                            if (val > 0) setIsMusicMuted(false);
                                                        }}
                                                        className="h-24 -rotate-90 origin-center accent-teal-500"
                                                        style={{ width: '80px' }}
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Game Area */}
                                <div className="flex-1 relative w-full h-full mt-10">
                                    {/* Path */}
                                    <svg className="absolute inset-0 w-full h-full pointer-events-none z-0" viewBox="0 0 100 100" preserveAspectRatio="none">
                                        {pathPoints.length > 1 && (
                                            <path
                                                d={`M ${pathPoints.map(p => `${p.x} ${p.y}`).join(' L ')}`}
                                                fill="none"
                                                stroke="#43A047"
                                                strokeWidth="3"
                                                strokeDasharray="3 3"
                                                className="opacity-90"
                                            />
                                        )}
                                    </svg>

                                    {/* Stations */}
                                    {questions.map((_, stageIndex) => {
                                        const point = pathPoints[stageIndex + 1];
                                        if (!point) return null;
                                        const isPassed = currentStationIndex > stageIndex + 1;
                                        const isCurrent = currentStationIndex === stageIndex + 1;

                                        return (
                                            <div
                                                key={stageIndex}
                                                className={`absolute w-16 h-16 md:w-20 md:h-20 -translate-x-1/2 -translate-y-1/2 transition-all duration-500 z-10 flex flex-col items-center ${isCurrent ? 'scale-125' : 'scale-100'} ${isPassed ? 'grayscale opacity-70' : ''}`}
                                                style={{ left: `${point.x}%`, top: `${point.y}%` }}
                                            >
                                                <WarningSVG />
                                                <div className="absolute -top-2 -right-2 bg-white text-green-700 font-bold w-8 h-8 rounded-full flex items-center justify-center border-2 border-green-500 shadow-sm text-sm">
                                                    {stageIndex + 1}
                                                </div>
                                            </div>
                                        );
                                    })}

                                    {/* Hive */}
                                    {pathPoints.length > 0 && (
                                        <div
                                            className="absolute w-32 h-32 md:w-44 md:h-44 -translate-x-1/2 -translate-y-1/2 z-20"
                                            style={{ left: `${pathPoints[pathPoints.length - 1].x}%`, top: `${pathPoints[pathPoints.length - 1].y}%` }}
                                        >
                                            <YogurtJarSVG className="drop-shadow-2xl filter brightness-110" />
                                        </div>
                                    )}

                                    {/* Start Point */}
                                    {pathPoints.length > 0 && (
                                        <div
                                            className="absolute w-12 h-12 -translate-x-1/2 -translate-y-1/2 z-0 opacity-80"
                                            style={{ left: `${pathPoints[0].x}%`, top: `${pathPoints[0].y}%` }}
                                        >
                                            <div className="bg-green-500/50 w-full h-full rounded-full animate-ping"></div>
                                            <div className="absolute inset-0 bg-green-500 w-full h-full rounded-full border-2 border-white flex items-center justify-center text-white font-bold text-xs shadow-md">
                                                START
                                            </div>
                                        </div>
                                    )}

                                    {/* Bee */}
                                    <div
                                        className="absolute z-30 w-24 h-24 md:w-36 md:h-36 -translate-x-1/2 -translate-y-1/2 transition-all duration-[2000ms] ease-in-out"
                                        style={{ left: `${beePosition.x}%`, top: `${beePosition.y}%` }}
                                    >
                                        <BacteriaSVG className="drop-shadow-2xl" />
                                    </div>
                                </div>
                            </div>
                        </React.Fragment>
                    )}

                    {gameState === GameStage.INTRO_VIDEO && renderVideoOverlay(INTRO_VIDEO_URL, handleIntroVideoEnded)}
                    {gameState === GameStage.OUTRO_VIDEO && renderVideoOverlay(OUTRO_VIDEO_URL, handleOutroVideoEnded)}

                    {isModalOpen && gameState === GameStage.PLAYING && questions[currentStationIndex - 1] && (
                        <QuestionModal
                            question={questions[currentStationIndex - 1]}
                            questionIndex={currentStationIndex - 1}
                            onAnswer={handleAnswer}
                            playCorrectSound={playCorrectSound}
                            playWrongSound={playWrongSound}
                            onPauseMusic={() => setIsTempPaused(true)}
                        />
                    )}

                    {(gameState === GameStage.VICTORY_PENDING || gameState === GameStage.VICTORY) && (
                        <VictoryScreen onRestart={handleRestart} onBackToSetup={handleBackToSetup} showButtons={gameState === GameStage.VICTORY} />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>